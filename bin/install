#!/bin/bash -eu
case "$1" in
  -v|--version)
    version="$2"
esac

# Set env files
echo "$version" > "$OPENSHIFT_PHP_DIR/env/OPENSHIFT_PHP_VERSION"
echo "$OPENSHIFT_PHP_DIR/configuration/etc/php.ini" > "$OPENSHIFT_PHP_DIR/env/PHPRC"
echo "$OPENSHIFT_PHP_DIR/configuration/etc/php.d/" > "$OPENSHIFT_PHP_DIR/env/PHP_INI_SCAN_DIR"

export PHP_INI_SCAN_DIR="$OPENSHIFT_PHP_DIR/configuration/etc/php.ini"
export PHP_INI_SCAN_DIR="$OPENSHIFT_PHP_DIR/configuration/etc/php.d/"
alias php=$OPENSHIFT_PHP_DIR/configuration/usr/bin/php

# This looks like httpd configuration
rm -f $OPENSHIFT_PHP_DIR/modules $OPENSHIFT_PHP_DIR/conf/magic
ln -s /usr/lib64/httpd/modules $OPENSHIFT_PHP_DIR/modules
ln -s /etc/httpd/conf/magic $OPENSHIFT_PHP_DIR/conf/magic

# Install rpm packages
pushd $OPENSHIFT_PHP_DIR/configuration
for file in ${OPENSHIFT_PHP_DIR}/versions/${version}/rpm/*.rpm
do
    rpm2cpio ${file} | cpio --extract --make-directories
done
popd

# Install pecl packages
#source ${OPENSHIFT_PHP_DIR}/versions/${version}/bin/install_pecl

# Pear setup
PEAR_BIN="$OPENSHIFT_PHP_DIR/configuration/usr/bin/pear"
rm -f $OPENSHIFT_HOMEDIR/.pearrc
${PEAR_BIN} config-create "$OPENSHIFT_PHP_DIR"/phplib/pear/ "$OPENSHIFT_HOMEDIR"/.pearrc
${PEAR_BIN} -c "$OPENSHIFT_HOMEDIR"/.pearrc config-set php_ini "$OPENSHIFT_PHP_DIR"/configuration/etc/php.ini
${PEAR_BIN} -c "$OPENSHIFT_HOMEDIR"/.pearrc config-set auto_discover 1
${PEAR_BIN} -c "$OPENSHIFT_HOMEDIR"/.pearrc config-set php_bin "$OPENSHIFT_PHP_DIR"/php/usr/bin/php
${PEAR_BIN} -c "$OPENSHIFT_HOMEDIR"/.pearrc config-set bin_dir "$OPENSHIFT_PHP_DIR"/php/usr/bin
